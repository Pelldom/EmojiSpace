# EmojiSpace - NPC Ship Generation and Salvage Contract

Status: LOCKED
Phase: 4.11 - NPC Ship Generation and Salvage
Target Version: 0.8.0
File: /design/npc_ship_generation_and_salvage_contract.md
Metadata Note: Header phase metadata corrected from 5.0 to 4.11 only. Behavioral rules unchanged.

----------------------------------------------------------------
1. Purpose
----------------------------------------------------------------

This contract defines deterministic rules for:

- Generating NPC ships (hull selection + partial loadout generation)
- Using the existing ship assembler as the single authority for ship stats
- Producing salvage modules immediately after combat destruction (option A: tight and simple)
- Combining salvage with existing reward materialization output without modifying reward_profiles.json

This contract defines BEHAVIOR and DETERMINISM ONLY.

It does NOT define:
- New hull or module schema fields
- New module secondary distribution weights
- New pricing formulas (other than referencing existing resale modifiers)
- Mission/event routing logic
- UI logic

----------------------------------------------------------------
2. Authority and Dependencies
----------------------------------------------------------------

2.1 Ship Stats Authority
- All NPC ship stats MUST be derived by calling assemble_ship(...) using:
  - hull_id
  - module_instances (including secondaries)
- No combat-side or generator-side duplication of bands, hull_max, RED, or capacities is permitted.

2.2 NPC Parity Rule
NPC generation MUST use:
- The same hull catalog (data/hulls.json)
- The same module catalog (data/modules.json)
- The same secondary rules and stacking rules as defined in ship_and_module_schema_contract.md

No NPC-only module variants, bonuses, or hidden modifiers are permitted.

2.3 Reward System Boundary
- reward_materializer.py and reward_profiles.json remain cargo/credits only.
- Salvage modules are generated by a salvage resolver and returned alongside materialized rewards.

----------------------------------------------------------------
3. Determinism Requirements
----------------------------------------------------------------

Given identical inputs:
- world_seed
- system_id
- system_population (1-5)
- encounter_id
- encounter_type_id (or subtype)
- npc_role (if present)

The generator MUST deterministically produce:
- selected hull_id
- installed module_instances list
- selected module secondaries
- salvage outputs

3.1 RNG Streams (Non-Negotiable)
Generators MUST use isolated deterministic RNG streams derived from a seed string:

seed_string = f"{world_seed}|{system_id}|{encounter_id}|{stream_name}"

Required stream_name values:
- "npc_hull_select"
- "npc_loadout_fill"
- "npc_module_select"
- "npc_secondary_rolls"
- "npc_salvage_count"
- "npc_salvage_select"
- "npc_salvage_mutation"

No other systems may reuse these streams.

----------------------------------------------------------------
4. NPC Hull Selection
----------------------------------------------------------------

4.1 Tier Selection (Population Weighted, Never Zero)
All tiers (1-5) MUST be possible at any population (1-5).
Weights are population-dependent and MUST be interpreted as relative weights.

Tier weights by population:

POP1:
- T1: 45
- T2: 30
- T3: 15
- T4: 7
- T5: 3

POP2:
- T1: 35
- T2: 30
- T3: 18
- T4: 12
- T5: 5

POP3 (Baseline):
- T1: 25
- T2: 25
- T3: 20
- T4: 20
- T5: 10

POP4:
- T1: 15
- T2: 20
- T3: 22
- T4: 23
- T5: 20

POP5:
- T1: 10
- T2: 15
- T3: 20
- T4: 25
- T5: 30

4.2 Frame Bias by Encounter Subtype (Minimal, Deterministic)
Frame bias is applied after tier selection, before final hull selection.

Encounter subtype to frame weights:

- civilian_trader_ship:
  - CIV: 80
  - FRG: 20
- civilian_patrol_ship:
  - CIV: 70
  - MIL: 30
- bounty_hunter:
  - MIL: 80
  - CIV: 20
- pirate_raider_ship:
  - MIL: 60
  - FRG: 25
  - CIV: 15
- derelict_ship:
  - CIV: 50
  - FRG: 35
  - MIL: 15
- alien_vessel:
  - ALN: 100
- experimental_vessel:
  - XA: 34
  - XB: 33
  - XC: 33

Notes:
- If a frame has no eligible hulls at the selected tier, fallback by removing that frame and renormalizing.
- If no hulls exist at the selected tier for any allowed frame, fallback to the nearest tier (prefer closer; break ties downward).

4.3 Hull Selection Within Tier and Frame
Eligible hull pool:
- hull.tier == selected_tier
- hull.frame in allowed frame set (post-bias resolution)
- Exclude hulls with availability_flags that forbid NPC appearance (future hook; default none)

Selection method:
- Deterministic weighted pick using hull.rarity_tier:
  - common: weight 50
  - uncommon: weight 30
  - rare: weight 15
  - unique: weight 5

Rationale:
- Unique hulls are possible but uncommon.
- This is separate from module rarity and salvage rarity.

----------------------------------------------------------------
5. NPC Loadout Generation (Partial Slots)
----------------------------------------------------------------

5.1 Slot Authority
Slot counts and slot types MUST NOT be stored in hull JSON.
Slot distribution MUST be derived from:
- tier
- frame
- ship_system slot matrix
(as already required by ship_and_module_schema_contract.md)

5.2 Slot Fill Fraction (Weighted, Midpoint at Half)
Define total_slots = number of slots from the slot matrix.

Select a fill_fraction bucket with these weights:

- 0% filled:   20
- 25% filled:  25
- 50% filled:  30
- 75% filled:  15
- 100% filled: 10

Notes:
- This makes less-than-half slightly more common than more-than-half.
- 0% is allowed (a bare hull encounter is valid).

filled_slots_target = round(total_slots * fill_fraction)

Clamp:
- min 0
- max total_slots

5.3 Slot Type Priority for Filling
When choosing which slots to fill, allocate in this priority order:
1) weapon slots
2) defense slots
3) utility slots
4) untyped slots

For untyped slots:
- The generator may choose a module of any slot_type compatible with untyped rules.

5.4 Minimum Combat Capability (Soft Rule)
For hostile encounter subtypes (pirate_raider_ship, bounty_hunter, civilian_patrol_ship):
- If filled_slots_target > 0, the generator SHOULD attempt to include at least:
  - 1 weapon-capable module OR a utility that implies combat capability
If impossible due to catalog constraints, proceed without forcing.

----------------------------------------------------------------
6. Module Selection for NPC Loadouts
----------------------------------------------------------------

6.1 Eligibility
A module is eligible for a slot if:
- module.slot_type matches the slot type, OR slot is untyped
- hull.frame is in module.allowed_on_frames if allowed_on_frames exists

6.2 Rarity Bias by Ship Tier (Not Tier Gating)
Modules are NOT tier-gated.
However, selection weights are biased by selected hull tier.

Define rarity multipliers by selected hull tier:

Tier 1:
- common: 1.00
- uncommon: 0.30
- rare: 0.10
- unique: 0.02

Tier 2:
- common: 1.00
- uncommon: 0.45
- rare: 0.15
- unique: 0.03

Tier 3:
- common: 1.00
- uncommon: 0.60
- rare: 0.25
- unique: 0.05

Tier 4:
- common: 1.00
- uncommon: 0.75
- rare: 0.40
- unique: 0.10

Tier 5:
- common: 1.00
- uncommon: 0.90
- rare: 0.55
- unique: 0.15

Final selection weight for a module:
module_weight = module.rarity_weight * rarity_multiplier_by_tier

6.3 Duplicates
- Duplicate modules are allowed.
- Deterministic selection may choose the same module_id multiple times if the catalog is small.

6.4 Secondary Tag Application
For each selected module instance:
- Apply secondary tags using the existing secondary distribution rules and stacking rules.
- No new secondary probability logic is permitted here.

----------------------------------------------------------------
7. Salvage Generation (Immediate After NPC Destruction)
----------------------------------------------------------------

7.1 Trigger
If an NPC ship is destroyed (hull_current reaches 0 in combat resolution):
- Salvage MUST be computed immediately after combat ends.
- Salvage is resolved once per destroyed NPC ship.

7.2 Salvage Count (Hard Cap)
Max salvage modules per destroyed ship: 2.

Select salvage_count with these weights:
- 0 modules: 50
- 1 module: 40
- 2 modules: 10

Notes:
- If ship has 0 installed modules, salvage_count is forced to 0.

7.3 Salvage Candidate Pool
Candidates are installed module instances on the destroyed NPC ship.
Inactive ship stripping rules are irrelevant (ship is destroyed, not mothballed).

7.4 Salvage Selection Weighting (Rarer Modules More Likely)
For each candidate module instance, compute salvage_weight:

rarity_factor:
- common: 1
- uncommon: 2
- rare: 4
- unique: 8

secondary_factor:
- none: 1.00
- unstable: 1.25
- prototype: 1.75
- alien: 2.50
- alien + non-alien: 3.00

salvage_weight = rarity_factor * secondary_factor

Selection method:
- Deterministic weighted selection WITHOUT replacement
- Select exactly salvage_count modules if possible
- If pool size < salvage_count, return the full pool

7.5 Salvage Mutation (Unstable Injection)
After salvage selection:
- For each salvaged module instance:
  - If it already has ANY secondary tag(s), unstable injection chance is 0.0
  - Else if salvage_policy.mutation_allowed is true:
    - Apply unstable injection with probability 0.20
  - Else:
    - No mutation

Notes:
- This is consistent with existing salvage mutation boundaries.
- No other secondaries may be introduced during salvage.

7.6 Prototype and Alien in Salvage
Prototype and alien modules are obtained only if:
- They already existed on the destroyed ship as selected module secondaries.
Salvage does not create prototype or alien.

----------------------------------------------------------------
8. Reward Integration Output Shape
----------------------------------------------------------------

8.1 Combined Reward Payload
Combat resolution returns a reward bundle with:
- materialized rewards (cargo/credits) from reward_materializer using reward_profile_id
- salvage modules (module instances) from salvage resolver

Recommended structure:

{
  "reward_profile_id": "string",
  "materialized": {
    "credits": integer,
    "cargo": [ { "sku_id": "string", "quantity": int, "stolen": bool }, ... ]
  },
  "salvage_modules": [ ModuleInstanceObject, ... ]
}

Notes:
- salvage_modules is independent from reward_profiles.json schema.
- Reward materialization logic remains unchanged.

----------------------------------------------------------------
9. Logging (Deterministic, Explainable)
----------------------------------------------------------------

NPC generation logs MUST include:
- selected tier and weights used
- selected frame bias resolution path
- chosen hull_id
- total slots and fill fraction bucket
- module selection list (module_id + secondaries)
- salvage_count roll and outcome
- salvage candidate weights and selected modules
- mutation checks and results

Logs must not contain random-only values without also logging the seed_string and stream_name used.

----------------------------------------------------------------
10. Explicit Exclusions
----------------------------------------------------------------

This phase does NOT include:
- new encounter types
- mission logic changes
- player salvage choice prompt
- looting cargo from ships beyond reward_profile materialization
- changes to reward_profiles.json schema
- changes to ship_and_module_schema_contract.md
- changes to secondary distribution weights
- changes to shipdock inventory system

----------------------------------------------------------------
11. Contract Authority
----------------------------------------------------------------

This document is authoritative for NPC ship generation and salvage behavior.
Any change requires:
- explicit contract revision
- version increment
- update to production_plan.md
